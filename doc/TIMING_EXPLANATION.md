# 1 秒ごとと 5 秒ごとの動作の整理

最終更新日: 2025 年 12 月

## 📋 現在の実装の動作

### ⏱️ 1 秒ごとの動作（`setInterval(..., 1000)`）

**実行タイミング**: 1 秒ごと（820 行目）

**実行内容**:

1. **`getMeetingParticipants()`を呼び出し**

   - 各参加者の最新状態を取得
   - 現在話している人（`currentSpeakerId`）の情報を取得

2. **`isMuted`の確認**

   - `isMuted === true`の場合 → **即座に発話終了**（1 秒以内）
   - `isSpeaking`を`false`にする
   - 話者なしに設定（`handleActiveSpeakerChange(null)`）
   - 処理を終了（`return`）

3. **`isSpeaking`の確認**

   - `isSpeaking === true`または`audioStatus === "speaking"`の場合
   - タイムアウトをリセット（`lastActiveSpeakerTimeRef.current = now`）
   - これにより、話し続けている間はタイムアウトしない

4. **エラーハンドリング**

   - `getMeetingParticipants()`が失敗した場合
   - 最後のアクティブスピーカーイベントからの経過時間を確認
   - 5 秒以上経過した場合、発話を終了

5. **経過時間の更新**
   - 現在話している人の経過時間を更新するための再レンダリングトリガー

---

### ⏱️ 5 秒ごとの動作

**実行タイミング**: **5 秒ごとの`setInterval`は存在しない**

**5 秒に関連する処理**:

1. **タイムアウトチェック（1 秒ごとのチェック内で実行）**

   - 最後のアクティブスピーカーイベントから 5 秒以上経過したか確認
   - 5 秒以上経過した場合:
     - `isSpeaking`が`true`の場合 → `false`にする
     - 話者なしに設定

2. **条件**:
   - `getMeetingParticipants()`が失敗した場合のみ実行
   - または、`isMuted`や`isSpeaking`の情報が取得できない場合

---

## 🔍 現在の実装の問題点

### 問題 1: `getMeetingParticipants()`が失敗している

- `callZoomApi`エラーが発生
- その結果、`isMuted`や`isSpeaking`の確認ができない
- 5 秒タイムアウトにフォールバックしている

### 問題 2: 5 秒ごとの動作が明確でない

- 5 秒ごとの`setInterval`は存在しない
- 1 秒ごとのチェック内で、5 秒経過を確認している
- これが混乱を招いている可能性がある

### 問題 3: ログが多すぎる

- 1 秒ごとに`getMeetingParticipants()`を呼び出している
- そのたびにログを出力している
- ログが多すぎて、重要な情報が見えにくい

---

## 📊 動作フロー

### 正常な動作フロー

```
1秒ごとのチェック開始
  ↓
getMeetingParticipants()を呼び出し
  ↓
現在話している人の情報を取得
  ↓
isMuted === true?
  ├─ YES → 即座に発話終了（1秒以内）
  └─ NO  → isSpeaking === true?
            ├─ YES → タイムアウトをリセット（lastActiveSpeakerTimeRefを更新）
            └─ NO  → 何もしない
```

### エラー時の動作フロー

```
1秒ごとのチェック開始
  ↓
getMeetingParticipants()を呼び出し
  ↓
エラー発生（callZoomApiエラー）
  ↓
最後のアクティブスピーカーイベントからの経過時間を確認
  ↓
5秒以上経過?
  ├─ YES → 発話を終了
  └─ NO  → 何もしない
```

---

## 🔧 推奨される改善

1. **`getMeetingParticipants()`のエラーを解決**

   - SDK の内部初期化を確実に待つ
   - エラーハンドリングを改善

2. **ログの最適化**

   - 重要な情報のみログに出力
   - デバッグモードでのみ詳細ログを出力

3. **動作の明確化**
   - 1 秒ごとの動作と 5 秒タイムアウトの関係を明確にする
   - コメントを追加して、動作を説明する
